<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>iFlashcards ‚Äî Choose, Swipe, Boom</title>
    <meta name="description" content="AI-powered flashcards. Upload anything, swipe to keep, study smarter.">
    <meta name="theme-color" content="#0a0a0f">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --bg-elevated: #22222e;
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-primary: #f4f4f5;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border: #27272a;
            --radius: 16px;
            --radius-sm: 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Space Grotesk', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
        }

        /* Animated background */
        .bg-gradient {
            position: fixed;
            inset: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(99, 102, 241, 0.15), transparent),
                radial-gradient(ellipse 60% 40% at 100% 100%, rgba(139, 92, 246, 0.1), transparent),
                var(--bg-primary);
            z-index: -1;
        }

        /* App Container */
        .app {
            max-width: 440px;
            margin: 0 auto;
            min-height: 100vh;
            min-height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            padding: 20px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent), #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-btns {
            display: flex;
            gap: 8px;
        }

        .nav-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .nav-btn:hover, .nav-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Screens */
        .screen {
            display: none;
            flex: 1;
            padding: 0 24px 24px;
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Home Screen */
        .hero {
            text-align: center;
            padding: 40px 0;
        }

        .hero h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 12px;
            line-height: 1.2;
        }

        .hero .tagline {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .hero .sub {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Input Methods */
        .input-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .input-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.25s ease;
        }

        .input-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.15);
        }

        .input-card .icon {
            font-size: 2rem;
            margin-bottom: 12px;
        }

        .input-card h3 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .input-card p {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Topic Search */
        .search-section {
            margin-bottom: 24px;
        }

        .search-box {
            display: flex;
            gap: 10px;
        }

        .search-input {
            flex: 1;
            padding: 16px 20px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-input:focus {
            border-color: var(--accent);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .btn {
            padding: 16px 24px;
            border-radius: var(--radius);
            border: none;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #5558e3;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card);
        }

        /* Hidden inputs */
        .hidden-input {
            display: none;
        }

        /* Text Input Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            align-items: flex-end;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: var(--radius) var(--radius) 0 0;
            width: 100%;
            max-width: 440px;
            max-height: 80vh;
            padding: 24px;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-header h2 {
            font-size: 1.2rem;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: var(--bg-elevated);
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
        }

        .text-area {
            width: 100%;
            height: 200px;
            padding: 16px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: 'JetBrains Mono', monospace;
            resize: none;
            outline: none;
            margin-bottom: 16px;
        }

        .text-area:focus {
            border-color: var(--accent);
        }

        /* Loading State */
        .loading-section {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .loading-section.active {
            display: flex;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-section p {
            color: var(--text-secondary);
        }

        /* Swipe Screen */
        .swipe-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 0;
        }

        .swipe-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .swipe-header h2 {
            font-size: 1.3rem;
            margin-bottom: 4px;
        }

        .swipe-header p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .card-stack {
            position: relative;
            width: 100%;
            max-width: 340px;
            height: 380px;
            perspective: 1000px;
        }

        .swipe-card {
            position: absolute;
            width: 100%;
            height: 100%;
            background: #1a1a24;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            cursor: grab;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .swipe-card.dragging {
            cursor: grabbing;
            transition: none;
        }

        .swipe-card .card-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent);
            margin-bottom: 12px;
        }

        .swipe-card .card-question {
            font-size: 1.1rem;
            font-weight: 500;
            line-height: 1.5;
            margin-bottom: 16px;
            flex: 1;
        }

        .swipe-card .card-answer {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.5;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            overflow-y: auto;
            flex: 1;
        }

        .swipe-indicator {
            position: absolute;
            top: 20px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .swipe-indicator.keep {
            right: 20px;
            background: var(--success);
            color: white;
        }

        .swipe-indicator.discard {
            left: 20px;
            background: var(--danger);
            color: white;
        }

        .swipe-actions {
            display: flex;
            gap: 16px;
            margin-top: 24px;
        }

        .swipe-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 2px solid;
            background: transparent;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .swipe-btn.discard {
            border-color: var(--danger);
            color: var(--danger);
        }

        .swipe-btn.discard:hover {
            background: var(--danger);
            color: white;
        }

        .swipe-btn.keep {
            border-color: var(--success);
            color: var(--success);
        }

        .swipe-btn.keep:hover {
            background: var(--success);
            color: white;
        }

        .swipe-progress {
            margin-top: 20px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Swipe Complete */
        .swipe-complete {
            display: none;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 40px 20px;
        }

        .swipe-complete.active {
            display: flex;
        }

        .swipe-complete .icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .swipe-complete h2 {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .swipe-complete p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .swipe-complete .btn {
            margin: 6px 0;
            width: 100%;
            max-width: 280px;
        }

        /* Decks Screen */
        .decks-header {
            margin-bottom: 20px;
        }

        .decks-header h2 {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .decks-header p {
            color: var(--text-muted);
        }

        .deck-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .deck-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .deck-item:hover {
            border-color: var(--accent);
            transform: translateX(4px);
        }

        .deck-item h3 {
            font-size: 1.1rem;
            margin-bottom: 6px;
        }

        .deck-meta {
            display: flex;
            gap: 16px;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        /* Study Screen */
        .study-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .study-header h2 {
            font-size: 1.3rem;
        }

        .study-progress {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .progress-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border);
        }

        .progress-dot.current {
            background: var(--accent);
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .progress-dot.done {
            background: var(--success);
        }

        .study-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            min-height: 300px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            position: relative;
        }

        .study-card.flipped {
            transform: rotateY(180deg);
        }

        .study-card .card-face {
            position: absolute;
            inset: 0;
            padding: 24px;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            border-radius: var(--radius);
        }

        .study-card .card-front {
            background: var(--bg-card);
        }

        .study-card .card-back {
            background: var(--bg-elevated);
            transform: rotateY(180deg);
        }

        .study-card .label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent);
            margin-bottom: 16px;
        }

        .study-card .content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.15rem;
            line-height: 1.6;
            text-align: center;
        }

        .study-card .hint {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .study-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .study-actions .btn {
            flex: 1;
            padding: 14px;
        }

        .rating-btns {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 24px;
        }

        .rating-btn {
            padding: 14px 10px;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.85rem;
            font-weight: 500;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rating-btn:hover {
            border-color: var(--accent);
        }

        .rating-btn.hard { border-color: var(--danger); color: var(--danger); }
        .rating-btn.good { border-color: var(--warning); color: var(--warning); }
        .rating-btn.easy { border-color: var(--success); color: var(--success); }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            padding: 14px 24px;
            border-radius: var(--radius);
            font-size: 0.95rem;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 200;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="bg-gradient"></div>
    
    <div class="app">
        <header>
            <div class="logo">iFlashcards</div>
            <div class="nav-btns">
                <button class="nav-btn active" onclick="showScreen('home')" title="Create">‚ú®</button>
                <button class="nav-btn" onclick="showScreen('decks')" title="My Decks">üìö</button>
            </div>
        </header>

        <!-- Home Screen -->
        <div id="homeScreen" class="screen active">
            <div class="hero">
                <h1>Choose, Swipe, Boom.</h1>
                <p class="tagline">AI-powered flashcards</p>
                <p class="sub">Upload anything. Keep what matters. Study smarter.</p>
            </div>

            <div class="search-section">
                <div class="search-box">
                    <input type="text" class="search-input" id="topicInput" placeholder="What do you want to learn?" onkeypress="if(event.key==='Enter') generateFromTopic()">
                    <button class="btn btn-primary" onclick="generateFromTopic()">Go</button>
                </div>
            </div>

            <div class="input-methods">
                <div class="input-card" onclick="document.getElementById('pdfInput').click()">
                    <div class="icon">üìÑ</div>
                    <h3>Upload PDF</h3>
                    <p>Notes, textbooks, slides</p>
                </div>
                <div class="input-card" onclick="document.getElementById('imageInput').click()">
                    <div class="icon">üì∑</div>
                    <h3>Take Photo</h3>
                    <p>Whiteboard, handwritten</p>
                </div>
                <div class="input-card" onclick="openTextModal()">
                    <div class="icon">üìù</div>
                    <h3>Paste Text</h3>
                    <p>Copy from anywhere</p>
                </div>
                <div class="input-card" onclick="document.getElementById('topicInput').focus()">
                    <div class="icon">üîç</div>
                    <h3>Search Topic</h3>
                    <p>AI researches for you</p>
                </div>
            </div>

            <input type="file" id="pdfInput" class="hidden-input" accept=".pdf" onchange="handlePDF(event)">
            <input type="file" id="imageInput" class="hidden-input" accept="image/*" capture="environment" onchange="handleImage(event)">
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="screen">
            <div class="loading-section active">
                <div class="spinner"></div>
                <p id="loadingText">Generating flashcards...</p>
            </div>
        </div>

        <!-- Swipe Screen -->
        <div id="swipeScreen" class="screen">
            <div class="swipe-container">
                <div class="swipe-header">
                    <h2>Review Your Cards</h2>
                    <p>Swipe right to keep, left to discard</p>
                </div>

                <div class="card-stack" id="cardStack"></div>

                <div class="swipe-actions">
                    <button class="swipe-btn discard" onclick="discardCard()">‚úï</button>
                    <button class="swipe-btn keep" onclick="keepCard()">‚úì</button>
                </div>

                <div class="swipe-progress" id="swipeProgress">1 of 10</div>
            </div>

            <div class="swipe-complete" id="swipeComplete">
                <div class="icon">üéâ</div>
                <h2>All Done!</h2>
                <p id="keptCount">You kept 8 cards</p>
                <button class="btn btn-primary" onclick="saveDeck()">Save to My Decks</button>
                <button class="btn btn-secondary" onclick="showScreen('home')">Generate More</button>
            </div>
        </div>

        <!-- Decks Screen -->
        <div id="decksScreen" class="screen">
            <div class="decks-header">
                <h2>My Decks</h2>
                <p>Your saved flashcard collections</p>
            </div>
            <div class="deck-list" id="deckList"></div>
        </div>

        <!-- Study Screen -->
        <div id="studyScreen" class="screen">
            <div class="study-header">
                <h2 id="studyDeckName">Study</h2>
                <button class="nav-btn" onclick="showScreen('decks')">‚úï</button>
            </div>

            <div class="study-progress" id="studyProgress"></div>

            <div class="study-card" id="studyCard" onclick="flipStudyCard()">
                <div class="card-face card-front">
                    <div class="label">Question</div>
                    <div class="content" id="studyQuestion"></div>
                    <div class="hint">Tap to reveal</div>
                </div>
                <div class="card-face card-back">
                    <div class="label">Answer</div>
                    <div class="content" id="studyAnswer"></div>
                    <div class="hint">Rate your recall</div>
                </div>
            </div>

            <div class="rating-btns" id="ratingBtns" style="display: none;">
                <button class="rating-btn hard" onclick="rateCard('hard')">üòì Hard</button>
                <button class="rating-btn good" onclick="rateCard('good')">ü§î Good</button>
                <button class="rating-btn easy" onclick="rateCard('easy')">üòé Easy</button>
            </div>
        </div>

        <!-- Text Input Modal -->
        <div class="modal-overlay" id="textModal">
            <div class="modal">
                <div class="modal-header">
                    <h2>Paste Your Content</h2>
                    <button class="modal-close" onclick="closeTextModal()">‚úï</button>
                </div>
                <textarea class="text-area" id="textContent" placeholder="Paste notes, article text, study material..."></textarea>
                <button class="btn btn-primary" style="width: 100%;" onclick="generateFromText()">Generate Cards</button>
            </div>
        </div>

        <!-- Toast -->
        <div class="toast" id="toast"></div>
    </div>

    <script>
        // State
        let generatedCards = [];
        let currentSwipeIndex = 0;
        let keptCards = [];
        let decks = JSON.parse(localStorage.getItem('iflashcards_decks') || '[]');
        let currentStudyDeck = null;
        let currentStudyIndex = 0;
        let currentTopic = '';

        // API endpoint
        const API_URL = 'https://iflashcards-api.iflashcards.workers.dev';

        // Screen management
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(screen + 'Screen').classList.add('active');
            
            if (screen === 'home') {
                document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
            } else if (screen === 'decks') {
                document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
                renderDecks();
            }
        }

        // Toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // Text Modal
        function openTextModal() {
            document.getElementById('textModal').classList.add('active');
        }

        function closeTextModal() {
            document.getElementById('textModal').classList.remove('active');
        }

        // Generate from topic
        async function generateFromTopic() {
            const topic = document.getElementById('topicInput').value.trim();
            if (!topic) {
                showToast('Enter a topic first!');
                return;
            }
            currentTopic = topic;
            await generateCards({ type: 'topic', content: topic });
        }

        // Generate from text
        async function generateFromText() {
            const text = document.getElementById('textContent').value.trim();
            if (!text) {
                showToast('Paste some content first!');
                return;
            }
            currentTopic = 'Pasted Notes';
            closeTextModal();
            await generateCards({ type: 'text', content: text });
        }

        // Handle PDF
        async function handlePDF(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            currentTopic = file.name.replace('.pdf', '');
            showScreen('loading');
            document.getElementById('loadingText').textContent = 'Extracting PDF text...';

            try {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                let text = '';
                
                for (let i = 1; i <= Math.min(pdf.numPages, 20); i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(item => item.str).join(' ') + '\n';
                }

                if (text.trim().length < 50) {
                    showToast('Could not extract enough text from PDF');
                    showScreen('home');
                    return;
                }

                await generateCards({ type: 'text', content: text.slice(0, 15000) });
            } catch (error) {
                console.error('PDF error:', error);
                showToast('Error reading PDF');
                showScreen('home');
            }
            event.target.value = '';
        }

        // Handle Image
        async function handleImage(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            currentTopic = 'Photo Notes';
            showScreen('loading');
            document.getElementById('loadingText').textContent = 'Analyzing image...';

            try {
                const base64 = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(file);
                });

                await generateCards({ type: 'image', content: base64 });
            } catch (error) {
                console.error('Image error:', error);
                showToast('Error processing image');
                showScreen('home');
            }
            event.target.value = '';
        }

        // Generate cards via API
        async function generateCards(input) {
            showScreen('loading');
            document.getElementById('loadingText').textContent = 'Generating flashcards...';

            try {
                let messages = [];
                const systemPrompt = `You are a flashcard generator. Create 10 high-quality flashcards from the provided content.

CRITICAL: Respond ONLY with a JSON array, no other text. Format:
[
  {"question": "...", "answer": "..."},
  {"question": "...", "answer": "..."}
]

Guidelines:
- Questions should test understanding, not just recall
- Answers MUST be complete sentences - never cut off mid-sentence
- Keep answers concise (2-3 sentences max) but always finish the thought
- Cover the key concepts thoroughly
- Vary question types (what, why, how, compare, etc.)`;

                if (input.type === 'topic') {
                    messages = [{
                        role: 'user',
                        content: `Create 10 flashcards about: ${input.content}\n\nResearch this topic thoroughly and create cards that cover the most important concepts a student should know.`
                    }];
                } else if (input.type === 'image') {
                    messages = [{
                        role: 'user',
                        content: [
                            { type: 'image', source: { type: 'base64', media_type: 'image/jpeg', data: input.content }},
                            { type: 'text', text: 'Create 10 flashcards from the content in this image.' }
                        ]
                    }];
                } else {
                    messages = [{
                        role: 'user',
                        content: `Create 10 flashcards from this content:\n\n${input.content}`
                    }];
                }

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4000,
                        system: systemPrompt,
                        messages: messages
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message || 'API error');
                }

                // Handle web search response - extract text from all text blocks
                let text = '';
                if (data.content && Array.isArray(data.content)) {
                    text = data.content
                        .filter(block => block.type === 'text')
                        .map(block => block.text)
                        .join('\n');
                }
                
                console.log('API response text:', text);
                
                const jsonMatch = text.match(/\[[\s\S]*\]/);
                if (!jsonMatch) {
                    throw new Error('Invalid response format - no JSON array found');
                }

                generatedCards = JSON.parse(jsonMatch[0]);
                currentSwipeIndex = 0;
                keptCards = [];
                
                showScreen('swipe');
                renderSwipeCards();

            } catch (error) {
                console.error('Generation error:', error);
                
                // Fall back to demo cards
                generatedCards = getDemoCards(input.type === 'topic' ? input.content : 'General');
                currentSwipeIndex = 0;
                keptCards = [];
                
                showToast('Using demo cards (API unavailable)');
                showScreen('swipe');
                renderSwipeCards();
            }
        }

        // Demo cards fallback
        function getDemoCards(topic) {
            return [
                { question: `What is the main concept of ${topic}?`, answer: `${topic} is a fundamental concept that encompasses key principles in its field.` },
                { question: `Why is ${topic} important?`, answer: `Understanding ${topic} helps build a foundation for more advanced concepts.` },
                { question: `How is ${topic} applied in practice?`, answer: `${topic} is applied through various methods and techniques in real-world scenarios.` },
                { question: `What are the key components of ${topic}?`, answer: `The key components include foundational elements that work together systematically.` },
                { question: `How does ${topic} relate to other concepts?`, answer: `${topic} connects with related areas through shared principles and applications.` },
                { question: `What are common misconceptions about ${topic}?`, answer: `A common misconception is oversimplifying the complexity of ${topic}.` },
                { question: `Who pioneered the study of ${topic}?`, answer: `Various researchers and practitioners have contributed to understanding ${topic}.` },
                { question: `What are the benefits of mastering ${topic}?`, answer: `Mastering ${topic} leads to better problem-solving and deeper understanding.` },
                { question: `What challenges exist in ${topic}?`, answer: `Challenges include complexity, implementation difficulties, and evolving best practices.` },
                { question: `What is the future outlook for ${topic}?`, answer: `The field continues to evolve with new developments and applications emerging.` }
            ];
        }

        // Render swipe cards
        function renderSwipeCards() {
            const stack = document.getElementById('cardStack');
            const complete = document.getElementById('swipeComplete');
            
            stack.parentElement.style.display = 'flex';
            complete.classList.remove('active');

            if (currentSwipeIndex >= generatedCards.length) {
                stack.parentElement.style.display = 'none';
                complete.classList.add('active');
                document.getElementById('keptCount').textContent = `You kept ${keptCards.length} cards`;
                return;
            }

            stack.innerHTML = '';
            
            // Show current and next card
            for (let i = Math.min(currentSwipeIndex + 1, generatedCards.length - 1); i >= currentSwipeIndex; i--) {
                const card = generatedCards[i];
                const cardEl = document.createElement('div');
                cardEl.className = 'swipe-card';
                cardEl.style.zIndex = generatedCards.length - i;
                
                if (i > currentSwipeIndex) {
                    cardEl.style.transform = 'scale(0.95) translateY(10px)';
                    cardEl.style.opacity = '0.5';
                }

                cardEl.innerHTML = `
                    <span class="swipe-indicator keep">KEEP ‚úì</span>
                    <span class="swipe-indicator discard">SKIP ‚úï</span>
                    <div class="card-label">Card ${i + 1}</div>
                    <div class="card-question">${card.question}</div>
                    <div class="card-answer">${card.answer}</div>
                `;

                if (i === currentSwipeIndex) {
                    setupSwipeGestures(cardEl);
                }

                stack.appendChild(cardEl);
            }

            document.getElementById('swipeProgress').textContent = 
                `${currentSwipeIndex + 1} of ${generatedCards.length}`;
        }

        // Swipe gestures
        function setupSwipeGestures(card) {
            let startX = 0;
            let currentX = 0;
            let isDragging = false;

            const onStart = (e) => {
                isDragging = true;
                startX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;
                card.classList.add('dragging');
            };

            const onMove = (e) => {
                if (!isDragging) return;
                currentX = (e.type === 'mousemove' ? e.clientX : e.touches[0].clientX) - startX;
                
                const rotation = currentX * 0.1;
                card.style.transform = `translateX(${currentX}px) rotate(${rotation}deg)`;
                
                const keepIndicator = card.querySelector('.swipe-indicator.keep');
                const discardIndicator = card.querySelector('.swipe-indicator.discard');
                
                if (currentX > 50) {
                    keepIndicator.style.opacity = Math.min((currentX - 50) / 50, 1);
                    discardIndicator.style.opacity = 0;
                } else if (currentX < -50) {
                    discardIndicator.style.opacity = Math.min((-currentX - 50) / 50, 1);
                    keepIndicator.style.opacity = 0;
                } else {
                    keepIndicator.style.opacity = 0;
                    discardIndicator.style.opacity = 0;
                }
            };

            const onEnd = () => {
                if (!isDragging) return;
                isDragging = false;
                card.classList.remove('dragging');

                if (currentX > 100) {
                    keepCard();
                } else if (currentX < -100) {
                    discardCard();
                } else {
                    card.style.transform = '';
                    card.querySelector('.swipe-indicator.keep').style.opacity = 0;
                    card.querySelector('.swipe-indicator.discard').style.opacity = 0;
                }
            };

            card.addEventListener('mousedown', onStart);
            card.addEventListener('mousemove', onMove);
            card.addEventListener('mouseup', onEnd);
            card.addEventListener('mouseleave', onEnd);
            card.addEventListener('touchstart', onStart, { passive: true });
            card.addEventListener('touchmove', onMove, { passive: true });
            card.addEventListener('touchend', onEnd);
        }

        function keepCard() {
            keptCards.push(generatedCards[currentSwipeIndex]);
            animateCardOut('right');
        }

        function discardCard() {
            animateCardOut('left');
        }

        function animateCardOut(direction) {
            const card = document.querySelector('.swipe-card');
            if (!card) return;
            
            const x = direction === 'right' ? 400 : -400;
            card.style.transition = 'transform 0.3s ease';
            card.style.transform = `translateX(${x}px) rotate(${x * 0.1}deg)`;
            
            setTimeout(() => {
                currentSwipeIndex++;
                renderSwipeCards();
            }, 300);
        }

        // Save deck
        function saveDeck() {
            if (keptCards.length === 0) {
                showToast('No cards to save!');
                return;
            }

            const deck = {
                id: Date.now(),
                name: currentTopic || 'Untitled Deck',
                cards: deduplicateCards([...keptCards]),
                createdAt: new Date().toISOString()
            };

            decks.unshift(deck);
            localStorage.setItem('iflashcards_decks', JSON.stringify(decks));
            
            showToast(`Saved ${deck.cards.length} cards to "${deck.name}"`);
            showScreen('decks');
        }

        // Deduplication
        function deduplicateCards(cards) {
            const seen = new Set();
            return cards.filter(card => {
                const key = card.question.toLowerCase().trim();
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });
        }

        // Render decks
        function renderDecks() {
            const list = document.getElementById('deckList');
            
            if (decks.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìö</div>
                        <h3>No decks yet</h3>
                        <p>Generate some flashcards to get started!</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = decks.map(deck => `
                <div class="deck-item" onclick="startStudy(${deck.id})">
                    <h3>${deck.name}</h3>
                    <div class="deck-meta">
                        <span>üìá ${deck.cards.length} cards</span>
                        <span>üìÖ ${new Date(deck.createdAt).toLocaleDateString()}</span>
                    </div>
                </div>
            `).join('');
        }

        // Start study session
        function startStudy(deckId) {
            currentStudyDeck = decks.find(d => d.id === deckId);
            if (!currentStudyDeck) return;
            
            currentStudyIndex = 0;
            document.getElementById('studyDeckName').textContent = currentStudyDeck.name;
            showScreen('study');
            renderStudyCard();
        }

        // Render study card
        function renderStudyCard() {
            const card = currentStudyDeck.cards[currentStudyIndex];
            const studyCard = document.getElementById('studyCard');
            
            studyCard.classList.remove('flipped');
            document.getElementById('ratingBtns').style.display = 'none';
            
            document.getElementById('studyQuestion').textContent = card.question;
            document.getElementById('studyAnswer').textContent = card.answer;
            
            // Update progress dots
            const progressDiv = document.getElementById('studyProgress');
            progressDiv.innerHTML = currentStudyDeck.cards.slice(0, 10).map((_, i) => 
                `<div class="progress-dot ${i < currentStudyIndex ? 'done' : ''} ${i === currentStudyIndex ? 'current' : ''}"></div>`
            ).join('');
        }

        // Flip study card
        function flipStudyCard() {
            const studyCard = document.getElementById('studyCard');
            studyCard.classList.toggle('flipped');
            
            if (studyCard.classList.contains('flipped')) {
                document.getElementById('ratingBtns').style.display = 'grid';
            }
        }

        // Rate card and move to next
        function rateCard(rating) {
            currentStudyIndex++;
            
            if (currentStudyIndex >= currentStudyDeck.cards.length) {
                showToast('üéâ Study session complete!');
                showScreen('decks');
                return;
            }
            
            renderStudyCard();
        }

        // Delete deck
        function deleteDeck(deckId) {
            decks = decks.filter(d => d.id !== deckId);
            localStorage.setItem('iflashcards_decks', JSON.stringify(decks));
            renderDecks();
            showToast('Deck deleted');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        });
    </script>
</body>
</html>
